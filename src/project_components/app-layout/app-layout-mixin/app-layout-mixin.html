<link rel="import" href="../../project-router/project-resizable-mixin.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/async.html">
<link rel="import" href="../../../bower_components/polymer/lib/utils/flush.html">

<script>
  (function() {

    window.Mixins = window.Mixins || {};
    window.Mixins.AppLayout = window.Mixins.AppLayout || function(superClass) {
      return class extends Mixins.Resizable(superClass) {
        constructor() {
          super();
          this._boundAppResetLayoutHandler = this._appResetLayoutHandler.bind(this);
          this._boundResetLayout = this.resetLayout.bind(this);
          this.addEventListener('app-reset-layout', this._boundAppResetLayoutHandler);
          this.addEventListener('iron-resize', this._boundResetLayout);
        }

        connectedCallback() {
          super.connectedCallback();
          this.dispatchEvent(new CustomEvent('app-reset-layout'));
        }

        _appResetLayoutHandler(e) {
          if (e.path[0] === this) {
            return;
          }
          this.resetLayout();
          e.stopPropagation();
        }

        _updateLayoutStates() {
          console.error('unimplemented');
        }
        /**
         * Resets the layout. If you changed the size of this element via CSS
         * you can notify the changes by either firing the `iron-resize` event
         * or calling `resetLayout` directly.
         *
         * @method resetLayout
         */
        resetLayout() {
          // Polymer v2.x
          var self = this;
          var cb = this._updateLayoutStates.bind(this);
          if (Polymer.Async && Polymer.Async.animationFrame) {
            this._layoutDebouncer = Polymer.Debouncer.debounce(
                this._layoutDebouncer,
                Polymer.Async.animationFrame,
                cb);
            Polymer.enqueueDebouncer(this._layoutDebouncer);
          }
          // Polymer v1.x
          else {
            window.cancelAnimationFrame(this._layoutDebouncer);
            this._layoutDebouncer = window.requestAnimationFrame(cb);
            Polymer.dom.addDebouncer({
              complete: function() {
                window.cancelAnimationFrame(self._layoutDebouncer);
                cb();
              }
            });
          }
          this._notifyDescendantResize();
        }

        _notifyLayoutChanged() {
          var self = this;
          // TODO: the event `app-reset-layout` can be fired synchronously
          // as long as `_updateLayoutStates` waits for all the microtasks after rAF.
          // E.g. requestAnimationFrame(setTimeOut())
          requestAnimationFrame(function() {
            // self.fire('app-reset-layout');
            self.dispatchEvent(new CustomEvent('app-reset-layout'))
          });
        }

        _notifyDescendantResize() {
          if (!this.isAttached) {
            return;
          }
          this._interestedResizables.forEach(function(resizable) {
            if (this.resizerShouldNotify(resizable)) {
              this._notifyDescendant(resizable);
            }
          }, this);
        }
      }
    }
  })();
</script>
